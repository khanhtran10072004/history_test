<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>Smart Garden Pro - Hybrid Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
Â body{font-family:sans-serif;text-align:center;background:#f4f7f6;padding:10px;color:#333;}
Â 
Â /* Style chung cho Dashboard vÃ  History Card */
Â .card{background:#fff;max-width:400px;margin:20px auto;padding:20px;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
Â .history-card { max-width:600px; } /* Má»Ÿ rá»™ng chiá»u rá»™ng cho báº£ng lá»‹ch sá»­ */

Â .row{display:flex;justify-content:space-between;margin:12px 0;border-bottom:1px dashed #eee;padding-bottom:5px;align-items:center;}
Â button{padding:12px;border:none;border-radius:8px;color:#fff;font-weight:bold;margin:5px;cursor:pointer;flex:1;}

Â .b-on{background:#27ae60;} .b-off{background:#c0392b;} 
Â .b-auto{background:#2980b9;} .b-man{background:#f39c12;color:#333;}
Â .b-dis{background:#e0e0e0!important;color:#999!important;pointer-events:none;}
Â 
Â /* NÃºt chuyá»ƒn trang chung */
Â .b-his { background: #8e44ad; width: 100%; margin-top: 15px; } 
Â .b-his:hover { background: #9b59b6; }
Â a { text-decoration: none; }

Â /* Style cho Lá»‹ch sá»­ View */
Â h2 {text-align:center; color:#2c3e50; margin-top:0;}
Â table {width:100%; border-collapse:collapse; margin-top:15px; font-size:14px;}
Â th {background:#34495e; color:white; padding:10px; text-align:left;}
Â td {border-bottom:1px solid #ddd; padding:12px 10px;}
Â .badge-on {color:#155724; font-weight:bold; background:#d4edda; padding:5px 10px; border-radius:15px; font-size:12px;}
Â .badge-off {color:#721c24; font-weight:bold; background:#f8d7da; padding:5px 10px; border-radius:15px; font-size:12px;}
Â 
Â /* TÃ¡i sá»­ dá»¥ng style .btn-back cá»§a báº¡n vÃ  Ä‘áº·t mÃ u Ä‘á»“ng bá»™ (vÃ­ dá»¥: b-auto) */
Â .btn-back-spa {display:block; width:100%; padding:12px; margin-bottom:15px; background:#2980b9; color:white; text-align:center; text-decoration:none; border-radius:8px; font-weight:bold; cursor:pointer;}
Â .btn-back-spa:hover {background:#1f6e9e;}
Â 
Â #status {text-align:center; color:gray; font-style:italic;}

Â #error-box { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(220,53,69,0.95); color:white; z-index:99; flex-direction:column; justify-content:center; align-items:center;}
Â input[type=number] { width:60px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:5px; }
Â input[type=time] { width:90px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:5px; }
Â input[type=range] { width: 100%; margin-right: 10px; }
Â .save-btn{background:#7f8c8d;font-size:12px;padding:5px 10px;flex:0;}
Â #mqtt-status { font-size: 12px; color: gray; }
</style>
</head>
<body>

<div id="error-box"><div style="font-size:20px;font-weight:bold;margin-bottom:20px;">âš ï¸ Cáº¢NH BÃO!<br>BÆ¡m 3 láº§n khÃ´ng áº©m!</div><button onclick="mqttSendCmd('MAN')" style="background:white;color:red;width:200px;">Táº®T BÃO Äá»˜NG</button></div>

<div id="dashboard-view" style="display: block;">
Â  <div class='card'>
Â  Â  <h3>VÆ°á»n ThÃ´ng Minh MQTT</h3>
Â  Â  <div id="mqtt-status">Äang káº¿t ná»‘i MQTT...</div>
Â  Â  <div class='row'><span>ğŸ•’ Giá»:</span><b id='time'>--</b></div>
Â  Â  <div class='row'><span>ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™:</span><b id='temp'>-- Â°C</b></div>
Â  Â  <div class='row'><span>ğŸ’§ Äá»™ áº©m Ä‘áº¥t:</span><b id='soil'>--</b></div>
Â  Â  <div class='row'><span>âš™ï¸ Cháº¿ Ä‘á»™:</span><b id='mode'>--</b></div>
Â  Â  <div class='row'><span>ğŸ”Œ MÃ¡y BÆ¡m:</span><b id='pump'>--</b></div>

Â  Â  <div id='admin' style='margin-top:20px;'>
Â  Â  Â  <div style='display:flex;'><button id='btnOn' class='b-on' onclick="mqttSendCmd('ON')">Báº¬T</button><button id='btnOff' class='b-off' onclick="mqttSendCmd('OFF')">Táº®T</button></div>
Â  Â  Â  <div style='display:flex;'><button id='btnAu' class='b-auto' onclick="mqttSendCmd('AUTO')">AUTO</button><button id='btnMan' class='b-man' onclick="mqttSendCmd('MAN')">THá»¦ CÃ”NG</button></div>
Â  Â  Â  
Â  Â  Â  <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>
Â  Â  Â  <div class='row' style="display:block;text-align:left;">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;"><span>ğŸš€ Tá»‘c Ä‘á»™ bÆ¡m:</span><b id="lblSpd">255</b></div>
Â  Â  Â  Â  <div style="display:flex;align-items:center;margin-top:5px;">
Â  Â  Â  Â  Â  <input type="range" id="rngSpd" min="70" max="255" oninput="updSpd(this.value)" onchange="sndSpd(this.value)">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <hr style='border:0;border-top:1px solid #eee;margin:15px 0;'>
Â  Â  Â  <div class='row'><span>Äáº¥t KhÃ´ Báº­t (>):</span><div><input type='number' id='inS'><button class='save-btn' onclick="setVal('S', 'inS', 1, 1023)">LÆ°u</button></div></div>
Â  Â  Â  <div class='row'><span>Nhiá»‡t Max (<):</span><div><input type='number' id='inT'><button class='save-btn' onclick="setVal('T', 'inT', 0, 100)">LÆ°u</button></div></div>
Â  Â  Â  <div class='row' style="display:block;text-align:left"><div>Giá» TÆ°á»›i:</div><div style="display:flex;justify-content:space-between;margin-top:5px;"><input type='time' step='1' id='inTS'> - <input type='time' step='1' id='inTE'><button class='save-btn' onclick="setTime()">LÆ°u</button></div></div>

Â  Â  Â  <hr style='border:0;border-top:1px dashed #eee;margin:15px 0;'>
Â  Â  Â  <div class='row'><span>â±ï¸ BÆ¡m (s):</span><div><input type='number' id='inPon'><button class='save-btn' onclick="setVal('PON', 'inPon', 1, 300)">LÆ°u</button></div></div>
Â  Â  Â  <div class='row'><span>â³ Nghá»‰ (s):</span><div><input type='number' id='inSoak'><button class='save-btn' onclick="setVal('SOAK', 'inSoak', 1, 600)">LÆ°u</button></div></div>

Â  Â  Â  Â  Â  Â  <a href="#" onclick="showView('history-view')"> 
Â  Â  Â  Â  <button class="b-his">ğŸ“œ Xem Lá»‹ch Sá»­ TÆ°á»›i CÃ¢y</button>
Â  Â  Â  </a>
Â  Â  </div>
Â  </div>
</div>

<div id="history-view" style="display: none;">
Â  <div class='card history-card'>
Â  Â  Â  Â  <a href="#" onclick="showView('dashboard-view')" class="btn-back-spa">â¬… Quay láº¡i Báº£ng Äiá»u Khiá»ƒn</a>
Â  Â  
Â  Â  <h2>ğŸ“œ Nháº­t KÃ½ Hoáº¡t Äá»™ng</h2>
Â  Â  <div id="status">Äang táº£i dá»¯ liá»‡u tá»« Cloud...</div>
Â  Â  
Â  Â  <table id="logTable" style="display:none;">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Thá»i gian</th>
Â  Â  Â  Â  Â  <th>Tráº¡ng thÃ¡i</th>
Â  Â  Â  Â  Â  <th>Äá»™ áº©m Ä‘áº¥t</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="tableBody">
Â  Â  Â  </tbody>
Â  Â  </table>
Â  </div>
</div>


<script>
// === THIáº¾T Láº¬P MQTT (Pháº§n nÃ y Ä‘Æ°á»£c giá»¯ nguyÃªn) ===
const MQTT_SERVER = "broker.hivemq.com";
const MQTT_PORT = 8884; 
const MQTT_CLIENT_ID = "Web_SmartGarden_" + parseInt(Math.random() * 100000); 
const TOPIC_STATUS = "sg/esp32/garden1/status";
const TOPIC_COMMAND = "sg/esp32/garden1/cmd";
const TOPIC_SETTINGS = "sg/esp32/garden1/set";

let mqttClient; Â 

function mqttConnect() {
Â  mqttClient = new Paho.MQTT.Client(MQTT_SERVER, MQTT_PORT, MQTT_CLIENT_ID); 
Â  mqttClient.onConnectionLost = onConnectionLost;
Â  mqttClient.onMessageArrived = onMessageArrived;

Â  let options = {timeout: 3, onSuccess: onConnect, onFailure: onFailure, useSSL: true};
Â  document.getElementById('mqtt-status').innerText = "Äang káº¿t ná»‘i...";
Â  mqttClient.connect(options);
}

function onConnect() {
Â  document.getElementById('mqtt-status').innerText = "âœ… ÄÃ£ káº¿t ná»‘i MQTT";
Â  mqttClient.subscribe(TOPIC_STATUS);
Â  console.log("MQTT Connected & Subscribed to " + TOPIC_STATUS);
}

function onFailure(responseObject) {
Â  document.getElementById('mqtt-status').innerText = "âŒ Lá»—i káº¿t ná»‘i MQTT. Thá»­ láº¡i sau 5s.";
Â  console.log("MQTT Failed: " + responseObject.errorMessage);
Â  setTimeout(mqttConnect, 5000);
}

function onConnectionLost(responseObject) {
Â  if (responseObject.errorCode !== 0) {
Â  Â  console.log("MQTT Connection Lost: " + responseObject.errorMessage);
Â  Â  mqttConnect();
Â  }
}

function onMessageArrived(message) {
Â  if (message.destinationName === TOPIC_STATUS) {
Â  Â  updateUI(JSON.parse(message.payloadString));
Â  }
}

function mqttSendCmd(cmd) {
Â  if (mqttClient && mqttClient.isConnected()) {
Â  Â  message = new Paho.MQTT.Message(cmd);
Â  Â  message.destinationName = TOPIC_COMMAND;
Â  Â  mqttClient.send(message);
Â  } else {
Â  Â  alert("ChÆ°a káº¿t ná»‘i MQTT! Vui lÃ²ng chá».");
Â  }
}

function mqttSendSetting(key, value) {
Â  if (mqttClient && mqttClient.isConnected()) {
Â  Â  message = new Paho.MQTT.Message(key + "=" + value);
Â  Â  message.destinationName = TOPIC_SETTINGS;
Â  Â  mqttClient.send(message);
Â  } else {
Â  Â  alert("ChÆ°a káº¿t ná»‘i MQTT! Vui lÃ²ng chá».");
Â  }
}

function updateUI(d){
Â  document.getElementById('time').innerText=d.time;
Â  document.getElementById('temp').innerText=d.t + ' Â°C';
Â  document.getElementById('soil').innerText=d.s;
Â  document.getElementById('mode').innerText=d.m?'AUTO':'THá»¦ CÃ”NG';
Â  
Â  let p=document.getElementById('pump');
Â  p.innerText=d.p?'CHáº Y ('+d.sspd+')':'Táº®T'; 
Â  p.style.color=d.p?'#27ae60':'#c0392b';
Â  document.getElementById('error-box').style.display = (d.err == 1) ? 'flex' : 'none';

Â  if(document.activeElement.tagName!='INPUT' && document.activeElement.tagName!='BUTTON'){
Â  Â  document.getElementById('inS').value=d.ss; document.getElementById('inT').value=d.st;
Â  Â  document.getElementById('inTS').value=d.sts.substring(0,5); 
Â  Â  document.getElementById('inTE').value=d.ste.substring(0,5); 
Â  Â  document.getElementById('inPon').value=d.spon; document.getElementById('inSoak').value=d.ssoak;
Â  Â  document.getElementById('rngSpd').value=d.sspd; document.getElementById('lblSpd').innerText=d.sspd;
Â  }
Â  
Â  let bOn=document.getElementById('btnOn'), bOff=document.getElementById('btnOff');
Â  let bAu=document.getElementById('btnAu'), bMan=document.getElementById('btnMan');
Â  if(d.m==1){ 
Â  Â  bOn.classList.add('b-dis'); bOff.classList.add('b-dis'); 
Â  Â  bAu.style.border="2px solid #333"; bMan.style.border="none"; bMan.style.opacity="0.5"; bAu.style.opacity="1";
Â  } else { 
Â  Â  bOn.classList.remove('b-dis'); bOff.classList.remove('b-dis'); 
Â  Â  bMan.style.border="2px solid #333"; bAu.style.border="none"; bAu.style.opacity="0.5"; bMan.style.opacity="1";
Â  }
};

function updSpd(v){ document.getElementById('lblSpd').innerText = v; }
function sndSpd(v){ mqttSendSetting('SPD', v); }
function setVal(key, id, min, max){
Â  let val = parseInt(document.getElementById(id).value);
Â  if(isNaN(val) || val < min || val > max){ alert("GiÃ¡ trá»‹ ko há»£p lá»‡!"); return;}
Â  mqttSendSetting(key, val); alert('ÄÃ£ lÆ°u!');
}
function setTime(){
Â  let t1 = document.getElementById('inTS').value; let t2 = document.getElementById('inTE').value;
Â  if(t1.length==5) t1+=":00"; if(t2.length==5) t2+=":00";
Â  mqttSendSetting('TS', t1); mqttSendSetting('TE', t2); alert('ÄÃ£ lÆ°u giá»!');
}


// === HÃ€M Xá»¬ LÃ Lá»ŠCH Sá»¬ (Firebase) ===
const DB_URL = "https://vuonthongminh-ffe93-default-rtdb.firebaseio.com/history.json?orderBy=\"$key\"&limitToLast=20";
let historyInterval; 

async function loadHistory() {
Â  try {
Â  Â  let response = await fetch(DB_URL);
Â  Â  let data = await response.json();
Â  Â  
Â  Â  let html = "";
Â  Â  if(data) {
Â  Â  Â  let arr = Object.values(data);
Â  Â  Â  arr.reverse(); 
Â  Â  Â  
Â  Â  Â  arr.forEach(item => {
Â  Â  Â  Â  let isBat = item.action.includes("BAT");
Â  Â  Â  Â  let badge = isBat 
Â  Â  Â  Â  Â  Â  ? `<span class="badge-on">Báº¬T BÆ M</span>` 
Â  Â  Â  Â  Â  Â  : `<span class="badge-off">Táº®T BÆ M</span>`;
Â  Â  Â  Â  
Â  Â  Â  Â  html += `<tr><td>${item.time}</td><td>${badge}</td><td>${item.soil}</td></tr>`;
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  document.getElementById("tableBody").innerHTML = html;
Â  Â  Â  document.getElementById("status").style.display = "none";
Â  Â  Â  document.getElementById("logTable").style.display = "table";
Â  Â  } else {
Â  Â  Â  document.getElementById("status").innerText = "ChÆ°a cÃ³ dá»¯ liá»‡u lá»‹ch sá»­ nÃ o.";
Â  Â  }
Â  } catch (e) {
Â  Â  console.error(e);
Â  Â  document.getElementById("status").innerText = "Lá»—i káº¿t ná»‘i! Kiá»ƒm tra láº¡i Link hoáº·c Rules.";
Â  }
}


// === HÃ€M QUáº¢N LÃ VIEW (SPA) ===
function showView(viewId) {
Â  // áº¨n/Hiá»‡n giao diá»‡n
Â  document.getElementById('dashboard-view').style.display = (viewId === 'dashboard-view') ? 'block' : 'none';
Â  document.getElementById('history-view').style.display = (viewId === 'history-view') ? 'block' : 'none';
Â  
Â  // Xá»­ lÃ½ bá»™ Ä‘áº¿m thá»i gian cho Lá»‹ch sá»­
Â  if (viewId === 'history-view') {
Â  Â  loadHistory(); // Táº£i ngay láº­p tá»©c
Â  Â  // Báº¯t Ä‘áº§u táº£i láº¡i má»—i 5s
Â  Â  historyInterval = setInterval(loadHistory, 5000); 
Â  } else {
Â  Â  // Ngá»«ng táº£i láº¡i lá»‹ch sá»­ khi quay vá» Dashboard
Â  Â  if (historyInterval) {
Â  Â  Â  clearInterval(historyInterval);
Â  Â  }
Â  }
}

// Báº¯t Ä‘áº§u káº¿t ná»‘i MQTT VÃ€ hiá»ƒn thá»‹ Dashboard khi trang táº£i xong
window.onload = function() {
Â  mqttConnect();
Â  showView('dashboard-view');
};
</script>

</body>
</html>
